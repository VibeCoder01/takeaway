<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crown City Menu Picker (Realtime)</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#101a34; --text:#e9ecf5; --muted:#a9b2c7;
      --brand:#7c5cff; --good:#22c55e; --danger:#ef4444; --line:rgba(255,255,255,.10);
      --shadow:0 18px 50px rgba(0,0,0,.35); --radius:18px;

      /* highlight for active-person selected items */
      --hi: rgba(245, 158, 11, 1);         /* amber */
      --hiSoft: rgba(245, 158, 11, .22);   /* glow */
      --hiSoft2: rgba(245, 158, 11, .10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1000px 600px at 10% 10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(1000px 700px at 90% 20%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 600px at 30% 90%, rgba(245,158,11,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      position:relative;
    }
    body::before{
      content:"";
      position:fixed;
      inset:-20%;
      background:
        radial-gradient(1200px 700px at 15% 25%, rgba(124,92,255,.22), transparent 60%),
        radial-gradient(1100px 800px at 85% 15%, rgba(34,197,94,.18), transparent 58%),
        radial-gradient(1000px 700px at 25% 85%, rgba(245,158,11,.14), transparent 60%);
      opacity:.9;
      pointer-events:none;
      z-index:-1;
      animation:blobDrift 12s ease-in-out infinite alternate;
    }
    @keyframes blobDrift{
      0%{transform:translate3d(-6%, -4%, 0) scale(1);}
      50%{transform:translate3d(6%, 8%, 0) scale(1.04);}
      100%{transform:translate3d(-4%, 6%, 0) scale(1.02);}
    }
    header{position:sticky; top:0; z-index:50; backdrop-filter:blur(10px); background:rgba(11,16,32,.75); border-bottom:1px solid var(--line);}
    .wrap{max-width:1200px; margin:0 auto; padding:12px;}
    .topbar{display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .titleBlock{display:flex; flex-direction:column; gap:2px; align-items:flex-start; flex:1;}
    .title{display:flex; gap:10px; align-items:center; min-width:220px;}
    h1{margin:0; font-size:34px; letter-spacing:.4px; line-height:1.1; font-weight:800;}
    .sub{margin:2px 0 0; color:var(--muted); font-size:12px}
    .controls{flex:1; display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap;}
    .sep{
      width:1px;
      height:28px;
      background:rgba(255,255,255,.12);
      margin:0 4px;
    }
    .fieldLabel{font-size:12px; color:var(--muted); margin-right:-4px;}
    .input, .select, .btn{
      border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text);
      border-radius:14px; padding:10px 12px; outline:none;
    }
    .input{min-width:200px}
    .searchMode{display:inline-flex; gap:6px; align-items:center;}
    .searchMode .btn.active{
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.14);
    }

    /* Fix the “white on white” select/options problem */
    .select{
      min-width:150px;
      background: rgba(0,0,0,.25);
      color: var(--text);
    }
    select option{
      background: #0b1020;
      color: #e9ecf5;
    }

    .btn{cursor:pointer; transition:transform .05s ease, background .2s ease, border-color .2s ease; user-select:none; display:inline-flex; align-items:center; gap:8px;}
    .btn:hover{background:rgba(255,255,255,.07); border-color:rgba(255,255,255,.18);}
    .btn:active{transform:translateY(1px);}
    .btn.small{font-size:12px; padding:6px 10px; border-radius:999px;}
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }
    .btn.primary{background:rgba(124,92,255,.18); border-color:rgba(124,92,255,.35);}
    .btn.primary:hover{background:rgba(124,92,255,.24); border-color:rgba(124,92,255,.55);}
    .btn.good{background:rgba(34,197,94,.16); border-color:rgba(34,197,94,.35);}
    .btn.good:hover{background:rgba(34,197,94,.22); border-color:rgba(34,197,94,.55);}
    .btn.danger{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.28);}
    .btn.danger:hover{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.42);}
    .chip{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.15); color:rgba(255,255,255,.9); display:inline-flex; gap:8px; align-items:center;}
    .chip.ok{border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.12);}
    .chip.bad{border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.10);}
    main .wrap{padding-top:18px; padding-bottom:40px;}
    .grid{display:grid; grid-template-columns:1.15fr 1fr; gap:16px; align-items:start;}
    @media (max-width:980px){.grid{grid-template-columns:1fr}.input{min-width:100%}.title{min-width:unset}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;}
    .cardhead{padding:14px; display:flex; gap:10px; align-items:flex-end; justify-content:space-between; border-bottom:1px solid var(--line); background:rgba(0,0,0,.12);}
    .cardhead h2{margin:0; font-size:24px; letter-spacing:.4px;}
    .hint{color:var(--muted); font-size:12px}
    .menu{padding:10px; display:flex; flex-direction:column; gap:10px;}
    .menuHeadActions{display:flex; flex-direction:column; align-items:flex-end; gap:8px;}
    .menuActions{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;}
    .menuActions .btn{font-size:12px; padding:6px 10px; border-radius:999px;}
    .legend{
      padding:10px 10px 6px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap:8px;
    }
    .legendActions{
      padding:0 10px 8px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
      flex-wrap:wrap;
    }
    .legendActions .btn{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
    }
    .legendActions .btn.active{
      border-color: rgba(34,197,94,.55);
      background: rgba(34,197,94,.16);
      color: var(--text);
    }
    .legendItem{
      display:flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.08);
      border-radius:999px;
      padding:6px 10px;
      background:rgba(0,0,0,.08);
    }
    .legendItem.btnLegend{
      cursor:pointer;
      transition:transform .05s ease, background .2s ease, border-color .2s ease, color .2s ease;
    }
    .legendItem.btnLegend:hover{
      background:rgba(255,255,255,.06);
      border-color:rgba(255,255,255,.16);
      color:var(--text);
    }
    .legendItem.btnLegend.active{
      border-color: rgba(239,68,68,.55);
      background: rgba(239,68,68,.12);
      color: var(--text);
    }
    .legendNum{
      width:22px;
      height:22px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-variant-numeric:tabular-nums;
      color:var(--text);
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      flex:0 0 22px;
    }
    details{border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.10); border-radius:16px; overflow:hidden;}
    summary{list-style:none; cursor:pointer; padding:12px; display:flex; align-items:center; justify-content:space-between; gap:10px; user-select:none;}
    summary::-webkit-details-marker{display:none}
    .cat{display:flex; gap:10px; align-items:center; font-weight:650; flex-wrap:wrap;}
    .pill{font-size:11px; color:rgba(255,255,255,.9); border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); padding:3px 8px; border-radius:999px;}
    .items{padding:0 10px 10px; display:grid; grid-template-columns:1fr; gap:8px;}
    .menu.dimmed{
      opacity:.45;
      filter:saturate(.7);
    }
    .menu.dimmed .item{
      pointer-events:none;
    }

    .item{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.03);
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease, transform .12s ease;
    }

    /* NEW: highlight when active person has qty > 0 */
    .item.selected{
      border-color: rgba(245,158,11,.55);
      background: linear-gradient(180deg, rgba(245,158,11,.10), rgba(255,255,255,.03));
      box-shadow:
        0 0 0 1px rgba(245,158,11,.25),
        0 0 24px rgba(245,158,11,.18);
    }

    .iname{font-weight:650; line-height:1.25}
    .idesc{margin-top:4px; font-size:12px; color:var(--muted); line-height:1.35}
    .meta{display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap;}
    .price{font-variant-numeric:tabular-nums; font-weight:700; padding:6px 10px; border-radius:999px; border:1px solid rgba(124,92,255,.35); background:rgba(124,92,255,.12);}
    .qty{display:flex; align-items:center; gap:6px; border:1px solid rgba(255,255,255,.12); border-radius:999px; padding:4px; background:rgba(0,0,0,.10);}
    .qty button{width:30px; height:30px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05); color:var(--text); cursor:pointer;}
    .qty button:hover{background:rgba(255,255,255,.08)}
    .qty span{min-width:18px; text-align:center; font-variant-numeric:tabular-nums; font-weight:700;}

    /* also make the qty badge pop when selected */
    .item.selected .qty{
      border-color: rgba(245,158,11,.45);
      box-shadow: 0 0 0 1px rgba(245,158,11,.18) inset;
    }
    .item.selected .price{
      border-color: rgba(245,158,11,.55);
      background: rgba(245,158,11,.10);
    }

    .people{padding:10px; display:flex; flex-direction:column; gap:10px;}
    .personTabs{display:flex; gap:8px; flex-wrap:wrap;}
    .peopleBar{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .peopleBar .tab{
      color: var(--text);
    }
    .tab{cursor:pointer; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); padding:8px 10px; font-size:13px; display:flex; gap:8px; align-items:center;}
    .tab.active{border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.12);}
    .tab .dot{width:9px; height:9px; border-radius:999px; background:rgba(255,255,255,.45);}
    .tab.active .dot{background:rgba(34,197,94,1)}
    .cart{border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.10); border-radius:16px; padding:10px; display:flex; flex-direction:column; gap:8px;}
    .cartItem{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03); border-radius:14px; padding:10px;}
    .cartItem .line1{font-weight:650; line-height:1.25}
    .cartItem .line2{font-size:12px; color:var(--muted); margin-top:4px}
    .totals{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .kpi{border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.10); border-radius:16px; padding:10px;}
    .kpi .label{color:var(--muted); font-size:12px}
    .kpi .value{margin-top:4px; font-weight:800; font-size:18px; font-variant-numeric:tabular-nums;}

    /* Modal */
    .overlay{
      position:fixed; inset:0; z-index:200;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding: 18px;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(1000px, 96vw);
      max-height: min(80vh, 780px);
      overflow:auto;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(16,26,52,.95), rgba(11,16,32,.95));
      box-shadow: var(--shadow);
    }
    .modalHead{
      position:sticky; top:0;
      padding: 14px;
      display:flex; justify-content:space-between; align-items:flex-end; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }
    .modalHead h3{margin:0; font-size:14px;}
    .modalBody{padding: 14px; display:flex; flex-direction:column; gap:12px;}
    .allSummaryGrand{
      display:inline-block;
      margin-left:6px;
      font-size:20px;
      font-weight:800;
      color:var(--text);
    }
    .personBlock{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      border-radius: 16px;
      overflow:hidden;
    }
    .personBlockHead{
      padding:12px;
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
    }
    .personBlockHead .headLeft{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .personBlockHead .chev{
      width:18px;
      height:18px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.2);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color:var(--muted);
    }
    .personBlock.collapsed .personLines{
      display:none;
    }
    .personName{font-weight:800;}
    .mini{color:var(--muted); font-size:12px}
    .personLines{padding: 10px; display:flex; flex-direction:column; gap:8px;}
    .lineRow{
      display:grid;
      grid-template-columns: 1fr auto auto auto;
      gap:10px;
      align-items:center;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:10px;
    }
    @media (max-width:720px){
      .lineRow{grid-template-columns: 1fr auto; grid-auto-rows:auto;}
      .lineRow .colHideOnSmall{display:none;}
    }
    .lineTitle{font-weight:650; line-height:1.2}
    .lineSub{margin-top:3px; font-size:12px; color:var(--muted)}
    .lineTotal{opacity:.7;}
    .mono{font-variant-numeric: tabular-nums; font-weight:700;}
    .rightMono{text-align:right;}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="titleBlock">
        <div class="title">
          <div>
          <h1>Crown City Menu Picker</h1>
          </div>
        </div>
        <div class="peopleBar">
          <button class="btn primary" id="addPersonBtn">＋ Add person</button>
          <button class="btn primary tabBtn" id="showAllBtn">Show ALL selected food.</button>
          <div class="personTabs" id="personTabs"></div>
        </div>
      </div>
      <div class="controls">
        <input id="search" class="input" type="search" placeholder="Search dishes (name / description / number)…" />
        <div class="searchMode" role="group" aria-label="Search mode">
          <button class="btn small active" id="searchModeAnd" type="button" aria-pressed="true">AND</button>
          <button class="btn small" id="searchModeOr" type="button" aria-pressed="false">OR</button>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid">
      <section class="card">
        <div class="cardhead">
          <div>
            <h2>Menu</h2>
            <div class="hint">Add/Pick a person, add items.</div>
          </div>
          <div class="menuHeadActions">
            <div class="hint" id="menuCount"></div>
            <div class="menuActions">
              <button class="btn" id="menuExpandAllBtn" type="button">Expand all</button>
              <button class="btn" id="menuCloseAllBtn" type="button">Close all</button>
            </div>
          </div>
        </div>
        <div class="menu" id="menu"></div>
      </section>

      <aside class="card">
        <div class="cardhead">
          <div>
            <h2 id="peopleTitle">Choices</h2>
          </div>
        </div>

        <div class="people">
          <div class="cart" id="cart"></div>

          <div class="totals">
            <div class="kpi">
              <div class="label">Active person total</div>
              <div class="value" id="personTotal">£0.00</div>
            </div>
            <div class="kpi">
              <div class="label">Grand total</div>
              <div class="value" id="grandTotal">£0.00</div>
            </div>
          </div>

          <div style="display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap;">
            <button class="btn danger" id="removePersonBtn">Remove</button>
            <button class="btn good" id="clearCartBtn">Clear</button>
          </div>

        </div>
      </aside>
    </div>
  </div>
</main>

<!-- Modal: All selections -->
<div class="overlay" id="allOverlay" role="dialog" aria-modal="true" aria-label="All selections">
  <div class="modal">
    <div class="modalHead">
      <div>
        <h3>All selections</h3>
        <div class="mini" id="allSummary">–</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button class="btn" id="expandAllBtn">Expand all</button>
        <button class="btn" id="collapseAllBtn">Collapse all</button>
        <button class="btn" id="copySummaryBtn" title="Copy text summary to clipboard">Copy summary</button>
        <button class="btn danger" id="closeAllBtn">Close</button>
      </div>
    </div>
    <div class="modalBody" id="allBody"></div>
  </div>
</div>

<script>
/* ===================== FULL MENU (literal JS data) ===================== */
const MENU = [
  {"category":"APPETISERS","items":[
    {"id":"1","name":"Hot Mix Special (Minimum for 2)","price":18.2,"desc":"Crispy Seaweed, Satay Chicken on Skewers, Crispy Won Ton, Sesame Prawns on Toast and Dry Barbecued Spare Ribs. Contains: Wheat, Crustaceans, Nut, Sesame, Soya."},
    {"id":"2","name":"House Hors D'oeuvres (Minimum for 2)","price":19.2,"desc":"Crispy Seaweed, Butterfly Prawns, Smoked Spicy Shredded Chicken, Peking Spare Ribs and Vegetarian Spring Rolls. Contains: Crustaceans, Egg, Soya, Celery."},
    {"id":"3","name":"Seafood Special Hors D'oeuvres (Minimum for 2)","price":21.5,"desc":"Crispy Seaweed, Squid in Peppercorn Salt, Crispy Fried Scallops, Paper Wrapped Prawns and Satay King Prawn on Skewers. Contains: Crustaceans, Egg."},
    {"id":"4","name":"Vegetarian Hors D'oeuvres (Minimum for 2)","price":17.0,"desc":"Crispy Seaweed, Vegetarian Spring Rolls, Fried Beancurds in Peppercorn Salt and Curry Samosa. Contains: Soya, Wheat."},
    {"id":"5","name":"Butterfly Prawns","price":9.9,"desc":"Contains: Crustaceans, Egg, Wheat."},
    {"id":"6","name":"Paper Wrapped Prawns","price":9.9,"desc":"Contains: Crustacean, Egg."},
    {"id":"7","name":"Fried King Prawns in Peppercorn Salt","price":9.9,"desc":"Contains: Egg, Crustacean. Gluten-free."},
    {"id":"8","name":"Sesame Prawns on Toast","price":9.9,"desc":"Contains: Crustacean, Sesame."},
    {"id":"9","name":"Satay King Prawns on Skewers","price":9.9,"desc":"Contains: Crustacean, Nut."},
    {"id":"10","name":"Steamed Mixed Dim Sum","price":9.9,"desc":"Contains: Wheat, Crustaceans, Soya, Sesame, Egg."},
    {"id":"11","name":"Steamed Dumplings","price":9.2,"desc":"Contains: Wheat, Soya."},
    {"id":"12","name":"Grilled Dumplings","price":9.2,"desc":"Contains: Wheat, Soya."},
    {"id":"13","name":"Fried Squid in Peppercorn Salt","price":9.9,"desc":"Contains: Crustacean, Egg, Wheat."},
    {"id":"14","name":"Fried Scallops in Peppercorn Salt","price":12.8,"desc":"Contains: Egg, Molluscs. Gluten-free."},
    {"id":"15","name":"Crispy Fried Scallops in Batter","price":12.8,"desc":"Contains: Wheat, Egg, Molluscs."},
    {"id":"16","name":"Crispy Fried Won Ton","price":9.2,"desc":"Contains: Wheat, Crustacean, Egg."},
    {"id":"17","name":"Dry Barbecued Spare Ribs","price":9.2,"desc":"Gluten-free."},
    {"id":"18","name":"Barbecued Spare Ribs in Sauce","price":9.2,"desc":"Contains: Wheat."},
    {"id":"19","name":"Ribs in Peppercorn Salt","price":9.2,"desc":"Contains: Egg. Gluten-free."},
    {"id":"20","name":"Peking Spare Ribs","price":9.2,"desc":"Contains: Celery."},
    {"id":"21","name":"Smoked Spicy Shredded Chicken","price":9.2,"desc":"Contains: Soya, Wheat."},
    {"id":"22","name":"Satay Chicken on Skewers","price":9.2,"desc":"Contains: Nut."},
    {"id":"23","name":"Fried Chicken in Peppercorn Salt","price":9.2,"desc":"Contains: Egg. Gluten-free."},
    {"id":"24","name":"Pork Chop in Peppercorn Salt","price":9.2,"desc":"Gluten-free."},
    {"id":"25a","name":"Fried Chicken Wings in Peppercorn Salt","price":8.9,"desc":"Contains: Egg, Wheat."},
    {"id":"25b","name":"Fried Chicken Wings in Mandarin Sauce","price":8.9,"desc":"Contains: Egg, Wheat, Celery."},
    {"id":"25","name":"Fried Beancurd in Peppercorn Salt","price":9.2,"desc":"Vegan. Contains: Soya."},
    {"id":"26","name":"Curry Samosa","price":6.7,"desc":"Vegan. Contains: Wheat."},
    {"id":"27","name":"Crispy Seaweed","price":6.7,"desc":"Vegan. Gluten-free."},
    {"id":"28","name":"Crispy Vegetarian Spring Rolls","price":6.7,"desc":"Vegan. Contains: Wheat."},
    {"id":"29","name":"Prawn Crackers","price":3.8,"desc":"Gluten-free. Contains: Crustaceans."}
  ]},
  {"category":"SPECIAL ELABORATE STARTERS","items":[
    {"id":"30","name":"Baked Lobster","price":68.0,"desc":"Contains: Crustaceans, Soya. With Ginger and Spring Onions / Black Bean Sauce."},
    {"id":"31","name":"Soft Shell Crab in Peppercorn Salt (2)","price":16.8,"desc":"Contains: Egg, Crustaceans. Gluten-free."},
    {"id":"32","name":"Crispy Vegetarian Duck","price":11.8,"desc":"Vegan. Contains: Soya, Wheat. Served with pancake cucumber spring onion & Hoi-Sin Sauce."},
    {"id":"33","name":"Crispy Aromatic Lamb","price":13.8,"desc":"Contains: Wheat. Served with Pancake Cucumber, Spring Onion & Plum Sauce."},
    {"id":"34A","name":"Crispy Aromatic Duck Quarter","price":13.8,"desc":"Contains: Wheat. Served with Pancake, Cucumber, Spring Onion & Hoi-Sin Sauce."},
    {"id":"34","name":"Crispy Aromatic Duck Half","price":26.5,"desc":"Contains: Wheat. Served with Pancake, Cucumber, Spring Onion & Hoi-Sin Sauce."}
  ]},
  {"category":"SOUPS","items":[
    {"id":"35","name":"Tom Yum Chicken Soup (Thai-Style)","price":5.5,"desc":"Contains: Soya."},
    {"id":"36","name":"Tom Yum Seafood Soup (Thai-Style)","price":5.9,"desc":"Contains: Soya, Crustaceans."},
    {"id":"37","name":"Hot and Sour Soup","price":4.8,"desc":"Contains: Soya, Egg, Crustaceans."},
    {"id":"38","name":"Vegetarian Hot and Sour Soup","price":4.2,"desc":"Vegan. Contains: Soya."},
    {"id":"39","name":"Won Ton Soup","price":4.8,"desc":"Contains: Wheat, Crustaceans, Soya."},
    {"id":"40","name":"Crab Meat and Sweetcorn Soup","price":4.8,"desc":"Gluten-free. Contains: Crustaceans."},
    {"id":"41","name":"Chicken and Sweetcorn Soup","price":4.8,"desc":"Gluten-free."},
    {"id":"42","name":"Mixed Vegetables Soup","price":4.2,"desc":"Vegan. Contains: Soya."},
    {"id":"43","name":"Chicken Mushroom Soup","price":4.8,"desc":"Contains: Soya."},
    {"id":"44","name":"Chicken Noodle Soup","price":4.8,"desc":"Contains: Soya."}
  ]},
  {"category":"SIZZLING HOT PLATES","items":[
    {"id":"45","name":"Sizzling Mixed Seafood Platter","price":14.8,"desc":"Contains: Crustacean, Molluscs, Soya."},
    {"id":"46","name":"Sizzling King Prawns with Black Bean Sauce","price":13.9,"desc":"Contains: Crustacean, Soya."},
    {"id":"47","name":"Sizzling King Prawns in Mandarin Sauce","price":13.9,"desc":"Contains: Crustaceans, Celery."},
    {"id":"48","name":"Sizzling King Prawns Ginger and Spring Onions","price":13.9,"desc":"Contains: Crustaceans, Soya."},
    {"id":"49","name":"Sizzling Mandarin Fillet Steak","price":17.5,"desc":"Contains: Celery."},
    {"id":"50","name":"Sizzling Fillet Steak with Black Pepper Sauce","price":17.5,"desc":"Contains: Soya."},
    {"id":"51","name":"Sizzling Beef with Satay Sauce","price":12.5,"desc":"Contains: Nut, Soya, Fish Sauce."},
    {"id":"52","name":"Sizzling Beef with Black Bean Sauce","price":12.5,"desc":"Contains: Soya."},
    {"id":"53","name":"Sizzling Beef with Ginger and Spring Onions","price":12.5,"desc":"Contains: Soya."},
    {"id":"54","name":"Sizzling Lamb with Black Bean Sauce","price":12.5,"desc":"Contains: Soya."},
    {"id":"55","name":"Sizzling Lamb with Ginger and Spring Onions","price":12.5,"desc":"Contains: Soya."},
    {"id":"56","name":"Sizzling Chicken with Satay Sauce","price":12.5,"desc":"Contains: Nut, Soya, Fish Sauce."},
    {"id":"57","name":"Sizzling Chicken with Black Bean Sauce","price":12.5,"desc":"Contains: Soya."},
    {"id":"58","name":"Sizzling Chicken with Ginger and Spring Onions","price":12.5,"desc":"Contains: Soya."},
    {"id":"59","name":"Sizzling Sliced Fillet of Pork in Mandarin Sauce","price":12.5,"desc":"Contains: Celery."},
    {"id":"60","name":"Sizzling Bean Curd with Satay Sauce","price":9.8,"desc":"Vegan. Contains: Nut, Soya."},
    {"id":"61","name":"Sizzling Bean Curd with Black Bean Sauce","price":9.8,"desc":"Vegan. Contains: Soya."},
    {"id":"62","name":"Sizzling Vegetarian Chicken with Black Bean Sauce","price":9.8,"desc":"Vegan. Contains: Soya."}
  ]},
  {"category":"SEAFOOD DISHES","items":[
    {"id":"63","name":"Steam Sea Bass with Spring Onions and Soya Sauce","price":25.8,"desc":"Contains: Fish, Soya."},
    {"id":"64","name":"Thai Style King Prawns","price":12.9,"desc":"Contains: Egg, Sesame, Crustacean."},
    {"id":"65","name":"Peking Kung Po King Prawns","price":12.9,"desc":"Contains: Egg, Soya."},
    {"id":"66","name":"Fierce Chilli King Prawns","price":12.9,"desc":"Contains: Crustacean, Soya."},
    {"id":"67","name":"Steamed Garlic Prawns","price":12.9,"desc":"Contains: Crustacean, Soya."},
    {"id":"68","name":"Sweet and Sour Prawns (Hong Kong Style)","price":12.9,"desc":"Gluten-free. Contains: Egg, Crustaceans."},
    {"id":"69","name":"Sweet and Sour Prawn Balls","price":12.9,"desc":"Contains: Wheat, Egg."},
    {"id":"70","name":"King Prawns Szechuan Style","price":12.9,"desc":"Contains: Wheat, Soya."},
    {"id":"71","name":"King Prawns with Asparagus","price":12.9,"desc":"Contains: Crustacean, Soya."},
    {"id":"72","name":"King Prawns with Cashewnuts and Yellow Bean Sauce","price":12.9,"desc":"Contains: Nut, Soya, Wheat."},
    {"id":"73","name":"Quick Fried Scallops","price":13.8,"desc":"Contains: Mollusc, Soya."},
    {"id":"74","name":"Steamed Scallops with Garlic or Black Bean Sauce (Min 2) (Each)","price":7.8,"desc":"Contains: Mollusc, Soya."},
    {"id":"75","name":"Fried Mussels in Black Bean Sauce","price":14.5,"desc":"Contains: Mollusc, Soya."},
    {"id":"76","name":"Fried Mussels with Special Chilli Sauce","price":14.5,"desc":"Contains: Molluscs, Soya."}
  ]},
  {"category":"MEAT DISHES","items":[
    {"id":"77","name":"Crispy Shredded Chilli Beef","price":9.9,"desc":"Contains: Egg."},
    {"id":"78","name":"Beef with Chilli and Lemon Grass","price":9.9,"desc":"Contains: Soya, Fish Sauce."},
    {"id":"79","name":"Beef with Fresh Mushrooms","price":9.9,"desc":"Contains: Soya."},
    {"id":"80","name":"Beef with Oyster Sauce","price":9.9,"desc":"Contains: Molluscs."},
    {"id":"81","name":"Sweet and Sour Pork (Hong Kong Style)","price":9.9,"desc":"Contains: Egg. Gluten-free."},
    {"id":"82","name":"Cantonese Roast Pork","price":9.9,"desc":"Contains: Wheat, Soya."}
  ]},
  {"category":"DUCK DISHES","items":[
    {"id":"83","name":"Duck with Plum Sauce","price":10.5,"desc":"Gluten-free."},
    {"id":"84","name":"Duck with Pineapple","price":10.5,"desc":"Gluten-free."},
    {"id":"85","name":"Duck with Black Bean Sauce","price":10.5,"desc":"Contains: Soya."},
    {"id":"86","name":"Duck with Ginger and Spring Onions","price":10.5,"desc":"Contains: Soya."},
    {"id":"87","name":"Cantonese Roast Duck","price":10.5,"desc":"Contains: Soya, Wheat."}
  ]},
  {"category":"POULTRY DISHES","items":[
    {"id":"88","name":"Thai Style Chicken","price":9.9,"desc":"Contains: Egg, Sesame."},
    {"id":"89","name":"Crispy Shredded Chilli Chicken","price":9.9,"desc":"Contains: Egg."},
    {"id":"90","name":"Peking Kung Po Chicken","price":9.9,"desc":"Contains: Egg, Soya."},
    {"id":"91","name":"Sweet and Sour Chicken (Hong Kong Style)","price":9.9,"desc":"Contains: Egg. Gluten-free."},
    {"id":"92","name":"Sweet and Sour Chicken Balls","price":9.9,"desc":"Contains: Wheat, Egg."},
    {"id":"93","name":"Lemon Chicken","price":9.9,"desc":"Contains: Egg. Gluten-free."},
    {"id":"94","name":"Chicken Szechuan Style","price":9.9,"desc":"Contains: Soya."},
    {"id":"95","name":"Chicken Chinese Style","price":9.9,"desc":"Contains: Soya, Wheat."},
    {"id":"96","name":"Chicken with Chilli and Lemon Grass","price":9.9,"desc":"Contains: Soya, Fish Sauce."},
    {"id":"97","name":"Chicken with Pineapple","price":9.9,"desc":"Gluten-free."},
    {"id":"98","name":"Chicken with Fresh Mushrooms","price":9.9,"desc":"Contains: Soya."},
    {"id":"99","name":"Chicken with Mixed Vegetables","price":9.9,"desc":"Contains: Soya."},
    {"id":"100","name":"Chicken with Oyster Sauce","price":9.9,"desc":"Contains: Soya, Molluscs."},
    {"id":"101","name":"Chicken with Cashewnuts and Yellow Bean Sauce","price":9.9,"desc":"Contains: Nut, Soya, Wheat."}
  ]},
  {"category":"CURRY","items":[
    {"id":"102","name":"Special Curry","price":9.9,"desc":"Contains: Wheat, Crustaceans."},
    {"id":"103","name":"King Prawns Curry","price":9.9,"desc":"Contains: Wheat, Crustaceans."},
    {"id":"104","name":"Chicken Curry","price":9.9,"desc":"Contains: Wheat."},
    {"id":"105","name":"Beef Curry","price":9.9,"desc":"Contains: Wheat."},
    {"id":"106","name":"Lamb Curry","price":9.9,"desc":"Contains: Wheat."},
    {"id":"107","name":"Mixed Vegetable Curry","price":7.9,"desc":"Vegan. Contains: Wheat."},
    {"id":"108","name":"King Prawns with Red Thai Curry","price":12.9,"desc":"Contains: Milk, Wheat, Crustaceans, Fish Sauce."},
    {"id":"109","name":"Chicken with Red Thai Curry","price":12.9,"desc":"Contains: Milk, Wheat, Crustaceans, Fish Sauce."}
  ]},
  {"category":"BEANCURD & VEGETABLES","items":[
    {"id":"110","name":"Braised Bean Curd Family Style (Hot)","price":7.5,"desc":"Contains: Soya."},
    {"id":"111","name":"Fried Bamboo Shoots and Chinese Mushrooms","price":7.5,"desc":"Vegan. Contains: Soya."},
    {"id":"112","name":"Chinese Vegetables with Oyster Sauce","price":7.5,"desc":"Contains: Molluscs."},
    {"id":"112A","name":"Chinese Vegetables with Garlic Sauce","price":7.5,"desc":"Vegan. Gluten-free."},
    {"id":"113","name":"Fried Aubergine with Special Chilli Sauce","price":7.5,"desc":"Contains: Soya."},
    {"id":"114","name":"Fried French Beans with Garlic","price":7.5,"desc":"Vegan. Gluten-free."},
    {"id":"115","name":"Fried Mixed Vegetables with Sweet Sour Sauce","price":7.5,"desc":"Vegan."},
    {"id":"116","name":"Fried Mixed Vegetables with Garlic Sauce","price":7.5,"desc":"Vegan."},
    {"id":"117","name":"Fried Mixed Vegetables with Satay Sauce","price":7.5,"desc":"Vegan. Contains: Soya, Nut, Wheat."},
    {"id":"118","name":"Fried Mixed Vegetables with Black Bean Sauce","price":7.5,"desc":"Contains: Soya."},
    {"id":"119","name":"Fried Beansprouts with Garlic","price":7.5,"desc":"Vegan. Gluten-free."},
    {"id":"120","name":"Fried Broccoli with Garlic Sauce","price":7.5,"desc":"Vegan. Gluten-free."},
    {"id":"121","name":"Fried Mange Tout with Garlic","price":7.5,"desc":"Vegan. Gluten-free."}
  ]},
  {"category":"RICE","items":[
    {"id":"122","name":"Lotus Leaf Wrapped Fried Rice","price":12.8,"desc":"Contains: Crustacean, Egg. Fried rice with chicken, prawns, duck and roast pork wrapped in lotus leaf."},
    {"id":"123","name":"Special Fried Rice","price":7.6,"desc":"Contains: Crustacean, Egg. Gluten-free."},
    {"id":"124","name":"Hot Singapore Fried Rice","price":7.6,"desc":"Contains: Crustacean, Egg. Gluten-free."},
    {"id":"125","name":"King Prawns Fried Rice","price":8.9,"desc":"Gluten-free. Contains: Crustacean, Egg."},
    {"id":"126","name":"Shrimps Fried Rice","price":7.6,"desc":"Gluten-free. Contains: Crustacean, Egg."},
    {"id":"127","name":"Chicken Fried Rice","price":6.9,"desc":"Gluten-free. Contains: Crustacean, Egg."},
    {"id":"128","name":"Beef Fried Rice","price":6.9,"desc":"Gluten-free. Contains: Crustacean, Egg."},
    {"id":"129","name":"Mushroom Fried Rice","price":5.9,"desc":"Vegan. Gluten-free."},
    {"id":"130","name":"Mixed Vegetable Fried Rice","price":5.9,"desc":"Vegan. Gluten-free."},
    {"id":"131","name":"Egg Fried Rice","price":5.3,"desc":"Gluten-free."},
    {"id":"132","name":"Boiled Rice","price":4.7,"desc":"Vegan. Gluten-free."}
  ]},
  {"category":"CHOW MEIN (SOFT NOODLES)","items":[
    {"id":"133","name":"Phad Thai (Flat Rice Noodles fried with Chicken)","price":9.5,"desc":"Gluten-free. Contains: Nut, Fish Sauce."},
    {"id":"134","name":"Phad Thai (Flat Rice Noodles fried with Prawns)","price":9.9,"desc":"Gluten-free. Contains: Nut, Fish Sauce."},
    {"id":"135","name":"Phad Thai (Flat Rice Noodles fried with Vegetables)","price":7.9,"desc":"Gluten-free. Contains: Nut, Fish Sauce."},
    {"id":"136","name":"Special Chow Mein (Dry)","price":7.9,"desc":"Contains: Crustaceans, Soya, Wheat."},
    {"id":"137","name":"Hot Singapore Fried Rice Noodles (Chicken, Roast Pork and Shrimps)","price":7.9,"desc":"Gluten-free. Contains: Egg, Crustaceans."},
    {"id":"138","name":"Vegetarian Hot Singapore Fried Rice Noodles","price":7.9,"desc":"Vegan. Gluten-free."},
    {"id":"139","name":"Shredded Duck Fried Rice Noodles","price":8.8,"desc":"Gluten-free."},
    {"id":"140","name":"King Prawns Chow Mein","price":9.9,"desc":"Contains: Crustacean, Soya."},
    {"id":"141","name":"Shrimps Chow Mein","price":7.6,"desc":"Contains: Crustacean, Soya."},
    {"id":"142","name":"Chicken Chow Mein","price":7.6,"desc":"Gluten-free."},
    {"id":"143","name":"Beef Chow Mein","price":7.6,"desc":"Contains: Soya."},
    {"id":"144","name":"Roast Pork Chow Mein","price":7.6,"desc":"Contains: Soya."},
    {"id":"145","name":"Mushroom Chow Mein","price":6.9,"desc":"Vegan. Contains: Soya."},
    {"id":"146","name":"Mixed Vegetable Chow Mein","price":6.9,"desc":"Vegan. Contains: Soya."},
    {"id":"147","name":"Noodles with Beansprouts","price":5.9,"desc":"Vegan. Contains: Soya."},
    {"id":"148","name":"Plain Noodles","price":5.9,"desc":"Vegan. Contains: Soya."}
  ]},
  {"category":"SPECIAL SET MEALS","items":[
    {"id":"A","name":"Set Meal A / Per Person (Minimum for 2 persons)","price":30.9,"desc":"Mixed Hors D'oeuvres (Crispy Seaweed, Sesame Prawns on Toast, Crispy Won Ton, Satay Chicken on Skewers, Barbecued Spare Ribs). Crispy Aromatic Duck / Crispy Lamb. Peking Kung Po Chicken. Sizzling Fillet Steak with Black Pepper sauce. Fried Mixed Vegetables. Egg Fried Rice."},
    {"id":"B","name":"Set Meal B / Per Person (Minimum for 2 persons)","price":31.9,"desc":"House Hors D'oeuvres (Crispy Seaweed, Butterfly Prawns, Smoked Spicy Shredded Chicken, Vegetarian Spring Rolls, Peking Spare Ribs). Crispy Aromatic Duck / Crispy Lamb. Shredded Chilli Beef. Sizzling King Prawns in Mandarin Sauce. Stir Fried Chicken with Mange Tout. Special Fried Rice."},
    {"id":"C","name":"Set Meal C / Per Person (Minimum for 2 persons)","price":27.5,"desc":"Vegetarian Hors D'oeuvres (Crispy Seaweed, Crispy Vegetarian Spring Rolls, Fried Beancurds in Peppercorn Salt, Curry Samosa). Crispy Vegetarian Duck. Sizzling Vegetarian Chicken Black Bean. Sizzling Beancurd with Satay Sauce. Fried Mange Tout with Beansprouts. Mixed Vegetable Fried Rice."},
    {"id":"D","name":"Set Meal D / Per Person (Minimum for 2 persons)","price":59.9,"desc":"Special Seafood Hors D'oeuvres (Crispy Seaweed, Paper Wrapped Prawns, Squid in Peppercorn Salt, Crispy Fried Scallops in Batter, Satay Prawns on Skewers). Baked Lobster. Sizzling Mandarin Fillet Steak. Stir Fried King Prawns with Asparagus. Chinese Vegetables with Oyster Sauce. Lotus Leaf Fried Rice."}
  ]}
];

/* ===================== Realtime logic ===================== */
let ws = null;
let serverVersion = 0;
let state = { people: [], activePersonId: null, ui: { search: "" } };
let searchMode = "and";
let openCats = new Set();
let localAllergens = new Set();
let roomHistory = [];
let dietFilters = { vegan: false, glutenFree: false };

function loadLocalAllergens(){
  try{
    const raw = localStorage.getItem("menuPickerAllergens");
    if(!raw) return;
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)) localAllergens = new Set(arr.map(n => Number(n)).filter(Boolean));
  }catch{
    localAllergens = new Set();
  }
}

function saveLocalAllergens(){
  const arr = Array.from(localAllergens).sort((a,b) => a - b);
  localStorage.setItem("menuPickerAllergens", JSON.stringify(arr));
}

function loadDietFilters(){
  try{
    const raw = localStorage.getItem("menuPickerDietFilters");
    const obj = raw ? JSON.parse(raw) : null;
    if(obj && typeof obj === "object"){
      dietFilters = {
        vegan: !!obj.vegan,
        glutenFree: !!obj.glutenFree,
      };
    }
  }catch{
    dietFilters = { vegan: false, glutenFree: false };
  }
}

function saveDietFilters(){
  localStorage.setItem("menuPickerDietFilters", JSON.stringify(dietFilters));
}

function loadRoomHistory(){
  try{
    const raw = localStorage.getItem("menuPickerRooms");
    const arr = raw ? JSON.parse(raw) : [];
    if(Array.isArray(arr)) roomHistory = arr.filter(Boolean);
  }catch{
    roomHistory = [];
  }
}

function saveRoomHistory(){
  localStorage.setItem("menuPickerRooms", JSON.stringify(roomHistory));
}

function updateRoomHistoryUI(){
  const sel = $("roomHistory");
  if(!sel) return;
  sel.innerHTML = "";
  const placeholder = document.createElement("option");
  placeholder.value = "";
  placeholder.textContent = "Recent sessions";
  sel.appendChild(placeholder);
  roomHistory.forEach(r => {
    const opt = document.createElement("option");
    opt.value = r;
    opt.textContent = r;
    sel.appendChild(opt);
  });
  sel.value = "";
}

function addRoomToHistory(room){
  const clean = String(room || "").trim();
  if(!clean) return;
  roomHistory = [clean, ...roomHistory.filter(r => r !== clean)].slice(0, 10);
  saveRoomHistory();
  updateRoomHistoryUI();
}

function removeRoomFromHistory(room){
  const clean = String(room || "").trim();
  if(!clean) return;
  roomHistory = roomHistory.filter(r => r !== clean);
  saveRoomHistory();
  updateRoomHistoryUI();
}
const ALLERGENS = [
  { code: 1, label: "Crustaceans", char: "①" },
  { code: 2, label: "Molluscs", char: "②" },
  { code: 3, label: "Nuts", char: "③" },
  { code: 4, label: "Milk", char: "④" },
  { code: 5, label: "Sesame seed", char: "⑤" },
  { code: 6, label: "Fish", char: "⑥" },
  { code: 8, label: "Egg", char: "⑧" },
  { code: 9, label: "Soya", char: "⑨" },
  { code: 10, label: "Cereal containing gluten", char: "⑩" },
  { code: 11, label: "Celery", char: "⑪" },
];
const ALLERGEN_CHAR_TO_CODE = Object.fromEntries(ALLERGENS.map(a => [a.char, a.code]));

const $ = (id) => document.getElementById(id);
const money = (n) => "£" + (Math.round((n + Number.EPSILON) * 100) / 100).toFixed(2);

function setConn(ok, text){
  const chip = $("connStatus");
  if(!chip) return;
  chip.classList.toggle("ok", ok);
  chip.classList.toggle("bad", !ok);
  chip.textContent = text;
}

function uid(){
  if (crypto?.randomUUID) return crypto.randomUUID();
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function itemKey(cat, id){ return `${cat}|${id}`; }

function findMenuItemByKey(key){
  const parts = key.split("|");
  const cat = parts[0], id = parts[1];
  const c = MENU.find(x => x.category === cat);
  if(!c) return null;
  return c.items.find(i => String(i.id) === String(id)) || null;
}

function getActivePerson(){
  return state.people.find(p => p.id === state.activePersonId) || null;
}

function setCartQty(person, key, qty){
  if(qty <= 0) delete person.cart[key];
  else person.cart[key] = qty;
}

function personTotal(person){
  let t = 0;
  for(const key in (person.cart || {})){
    const qty = person.cart[key];
    const it = findMenuItemByKey(key);
    if(it) t += it.price * qty;
  }
  return t;
}

function grandTotal(){
  return state.people.reduce((sum, p) => sum + personTotal(p), 0);
}

function menuItemMatchesSearch(item, terms, mode){
  if(terms.length === 0) return true;
  const hay = `${item.id} ${item.name} ${(item.desc||"")}`.toLowerCase();
  if(mode === "or") return terms.some(t => hay.includes(t));
  return terms.every(t => hay.includes(t));
}

function getSearchTerms(){
  const raw = ($("search").value || "").trim().toLowerCase();
  if(!raw) return [];
  return raw.split(/\s+/).filter(Boolean);
}

function setSearchMode(mode){
  searchMode = mode === "or" ? "or" : "and";
  const andBtn = $("searchModeAnd");
  const orBtn = $("searchModeOr");
  andBtn.classList.toggle("active", searchMode === "and");
  orBtn.classList.toggle("active", searchMode === "or");
  andBtn.setAttribute("aria-pressed", searchMode === "and" ? "true" : "false");
  orBtn.setAttribute("aria-pressed", searchMode === "or" ? "true" : "false");
  render();
}

function itemAllergens(item){
  const text = `${item.name || ""} ${item.desc || ""}`.toLowerCase();
  const codes = new Set();

  const matches = text.match(/[①②③④⑤⑥⑦⑧⑨⑩⑪⑫⑬⑭]/g) || [];
  matches.forEach((ch) => {
    const code = ALLERGEN_CHAR_TO_CODE[ch];
    if(code) codes.add(code);
  });

  const keywordMap = [
    { code: 1, terms: ["crustacean", "crustaceans", "prawn", "prawns", "shrimp", "shrimps", "lobster", "crab", "crabmeat", "crab meat"] },
    { code: 2, terms: ["mollusc", "molluscs", "scallop", "scallops", "mussel", "mussels", "squid", "octopus", "cuttlefish", "oyster sauce", "oyster"] },
    { code: 3, terms: ["nut", "nuts", "cashew", "cashewnut", "cashewnuts", "peanut", "peanuts", "satay"] },
    { code: 4, terms: ["milk", "cream", "butter", "cheese"] },
    { code: 5, terms: ["sesame"] },
    { code: 6, terms: ["fish", "fish sauce", "sea bass", "seabass"] },
    { code: 7, terms: ["mustard"] },
    { code: 8, terms: ["egg", "eggs"] },
    { code: 9, terms: ["soya", "soy"] },
    { code: 10, terms: ["wheat", "gluten", "cereal", "noodle", "noodles", "pancake", "batter"] },
    { code: 11, terms: ["celery"] },
    { code: 12, terms: ["sulphur dioxide", "sulfur dioxide", "sulphur"] },
    { code: 13, terms: ["lupin"] },
  ];

  keywordMap.forEach(({code, terms}) => {
    if(terms.some(term => text.includes(term))) codes.add(code);
  });

  return Array.from(codes);
}

function itemBlockedByAllergens(item, blocked){
  if(!blocked || blocked.size === 0) return false;
  const codes = itemAllergens(item);
  return codes.some(c => blocked.has(c));
}

function itemMatchesDiet(item){
  const text = `${item.name || ""} ${item.desc || ""}`.toLowerCase();
  if(dietFilters.vegan && !text.includes("vegan")) return false;
  if(dietFilters.glutenFree && !text.includes("gluten-free") && !text.includes("gluten free")) return false;
  return true;
}

function sendPatch(){
  if(!ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({
    type: "patch",
    baseVersion: serverVersion,
    patch: { op: "set_state", state }
  }));
}

function getRoomValue(){
  const input = $("room");
  return (input && input.value.trim()) ? input.value.trim() : "default";
}

function setRoomValue(value){
  const input = $("room");
  if(input) input.value = value;
}

function connect(){
  const room = getRoomValue();
  const wsUrl = `ws://${location.host}/ws`;

  if(ws) try { ws.close(); } catch {}
  setConn(false, "Connecting…");
  addRoomToHistory(room);

  ws = new WebSocket(wsUrl);
  ws.onopen = () => ws.send(JSON.stringify({ type:"join", room }));

  ws.onmessage = (ev) => {
    let msg;
    try { msg = JSON.parse(ev.data); } catch { return; }
    if(msg.type === "error"){
      setConn(false, "Error");
      if(msg.error) alert(msg.error);
      return;
    }
    if(msg.type === "room_deleted"){
      const room = msg.room || getRoomValue();
      setConn(false, "Session deleted");
      removeRoomFromHistory(room);
      state = { people: [], activePersonId: null, ui: { search: "" } };
      render();
      setRoomValue("default");
      connect();
      return;
    }
    if(msg.type === "full_state"){
      serverVersion = msg.version || 0;
      state = msg.state;
      setConn(true, "Connected");
      render();
    }
  };

  ws.onclose = () => setConn(false, "Disconnected");
  ws.onerror = () => setConn(false, "Disconnected");
}

function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function render(){
  renderPeopleControls();
  renderMenu();
  renderCart();
  renderTotals();
}

function renderPeopleControls(){
  const people = state.people || [];
  if(people.length === 0){
    state.activePersonId = null;
  } else {
    if(!people.some(p => p.id === state.activePersonId)){
      state.activePersonId = people[0].id;
    }
  }

  const tabs = $("personTabs");
  tabs.innerHTML = "";
  people.forEach(p => {
    const b = document.createElement("button");
    b.className = "tab" + (p.id === state.activePersonId ? " active" : "");
    b.type = "button";
    b.innerHTML = `<span class="dot"></span><span>${escapeHtml(p.name)}</span>`;
    b.onclick = () => { state.activePersonId = p.id; sendPatch(); };
    tabs.appendChild(b);
  });
  const showAllBtn = $("showAllBtn");
  if(showAllBtn){
    const hasActive = !!getActivePerson();
    showAllBtn.disabled = !hasActive;
  }

  const removeBtn = $("removePersonBtn");
  if(removeBtn){
    const active = getActivePerson();
    removeBtn.textContent = active ? `Remove ${active.name}` : "Remove";
    removeBtn.disabled = !active;
  }

  const clearBtn = $("clearCartBtn");
  if(clearBtn){
    const active = getActivePerson();
    clearBtn.textContent = active ? `Clear ${active.name}'s choices` : "Clear choices";
    clearBtn.disabled = !active;
  }

  const peopleTitle = $("peopleTitle");
  if(peopleTitle){
    const active = getActivePerson();
    peopleTitle.textContent = active ? `${active.name}'s choices` : "Choices";
    peopleTitle.closest(".cardhead").style.display = active ? "" : "none";
  }
}

function renderMenu(){
  const q = ($("search").value || "").trim().toLowerCase();
  const terms = getSearchTerms();
  const menuEl = $("menu");
  menuEl.innerHTML = "";

  menuEl.classList.toggle("dimmed", !getActivePerson());

  let shownItems = 0, totalItems = 0;
  const blocked = localAllergens;

  const dietSelectedCount = (dietFilters.vegan ? 1 : 0) + (dietFilters.glutenFree ? 1 : 0);
  const legendDetails = document.createElement("details");
  legendDetails.open = openCats.has("allergen-key");
  legendDetails.addEventListener("toggle", () => {
    if(legendDetails.open) openCats.add("allergen-key");
    else openCats.delete("allergen-key");
  });
  const legendSummary = document.createElement("summary");
  legendSummary.innerHTML = `
      <div class="cat">
        <span>Allergen key</span>
        <span class="pill">${ALLERGENS.length} items · ${blocked.size} allergen(s) · ${dietSelectedCount} diet</span>
      </div>
      <div class="hint">Select allergen(s) to remove from list.</div>
    `;
  const legendActions = document.createElement("div");
  legendActions.className = "legendActions";
  const clearBtn = document.createElement("button");
  clearBtn.type = "button";
  clearBtn.className = "btn";
  clearBtn.textContent = "Clear filters";
  clearBtn.disabled = localAllergens.size === 0 && !dietFilters.vegan && !dietFilters.glutenFree;
  clearBtn.onclick = () => {
    if(localAllergens.size === 0 && !dietFilters.vegan && !dietFilters.glutenFree) return;
    localAllergens.clear();
    dietFilters = { vegan: false, glutenFree: false };
    saveLocalAllergens();
    saveDietFilters();
    render();
  };
  legendActions.appendChild(clearBtn);

  const veganBtn = document.createElement("button");
  veganBtn.type = "button";
  veganBtn.className = "btn";
  veganBtn.textContent = "Vegan only";
  veganBtn.setAttribute("aria-pressed", dietFilters.vegan ? "true" : "false");
  if(dietFilters.vegan) veganBtn.classList.add("active");
  veganBtn.onclick = () => {
    dietFilters.vegan = !dietFilters.vegan;
    saveDietFilters();
    render();
  };
  legendActions.appendChild(veganBtn);

  const gfBtn = document.createElement("button");
  gfBtn.type = "button";
  gfBtn.className = "btn";
  gfBtn.textContent = "Gluten-free only";
  gfBtn.setAttribute("aria-pressed", dietFilters.glutenFree ? "true" : "false");
  if(dietFilters.glutenFree) gfBtn.classList.add("active");
  gfBtn.onclick = () => {
    dietFilters.glutenFree = !dietFilters.glutenFree;
    saveDietFilters();
    render();
  };
  legendActions.appendChild(gfBtn);

  const legendList = document.createElement("div");
  legendList.className = "legend";
  ALLERGENS.forEach(a => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "legendItem btnLegend" + (blocked.has(a.code) ? " active" : "");
    btn.setAttribute("aria-pressed", blocked.has(a.code) ? "true" : "false");
    btn.innerHTML = `<span class="legendNum">${a.code}</span>${a.label}`;
    btn.onclick = () => {
      if(localAllergens.has(a.code)) localAllergens.delete(a.code);
      else localAllergens.add(a.code);
      saveLocalAllergens();
      render();
    };
    legendList.appendChild(btn);
  });
  legendDetails.append(legendSummary, legendActions, legendList);
  menuEl.appendChild(legendDetails);

  MENU.forEach(section => {
    const allowed = section.items.filter(it => !itemBlockedByAllergens(it, blocked) && itemMatchesDiet(it));
    totalItems += allowed.length;
    const items = allowed.filter(it => menuItemMatchesSearch(it, terms, searchMode));
    if(items.length === 0) return;
    shownItems += items.length;

    const det = document.createElement("details");
    det.open = q ? true : openCats.has(section.category);
    det.addEventListener("toggle", () => {
      if(det.open) openCats.add(section.category);
      else openCats.delete(section.category);
    });

    const sum = document.createElement("summary");
    sum.innerHTML = `
      <div class="cat">
        <span>${escapeHtml(section.category)}</span>
        <span class="pill">${items.length} item${items.length!==1?"s":""}</span>
      </div>
      <div class="hint">tap</div>
    `;

    const list = document.createElement("div");
    list.className = "items";

    items.forEach(it => {
      const row = document.createElement("div");
      row.className = "item";

      const currentQty = activeQty(section.category, it.id);
      if(currentQty > 0) row.classList.add("selected");

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="iname">${escapeHtml(it.id)}. ${escapeHtml(it.name)}</div>
        ${it.desc ? `<div class="idesc">${escapeHtml(it.desc)}</div>` : ""}
      `;

      const right = document.createElement("div");
      right.className = "meta";

      const price = document.createElement("div");
      price.className = "price";
      price.textContent = money(it.price);

      const qty = document.createElement("div");
      qty.className = "qty";

      const minus = document.createElement("button");
      minus.type = "button";
      minus.textContent = "−";
      minus.onclick = () => adjustActive(section.category, it, -1);

      const count = document.createElement("span");
      count.textContent = String(currentQty);

      const plus = document.createElement("button");
      plus.type = "button";
      plus.textContent = "+";
      plus.onclick = () => adjustActive(section.category, it, +1);

      qty.append(minus, count, plus);
      right.append(price, qty);

      row.append(left, right);
      list.appendChild(row);
    });

    det.append(sum, list);
    menuEl.appendChild(det);
  });

  $("menuCount").textContent = q ? `${shownItems} matched (of ${totalItems})` : `${totalItems} items`;

  function activeQty(cat, id){
    const p = getActivePerson();
    if(!p) return 0;
    const key = itemKey(cat, id);
    return (p.cart && p.cart[key]) ? p.cart[key] : 0;
  }

  function adjustActive(cat, it, delta){
    const p = getActivePerson();
    if(!p) return;
    if(!p.cart) p.cart = {};
    const key = itemKey(cat, it.id);
    const next = Math.max(0, (p.cart[key] || 0) + delta);
    setCartQty(p, key, next);
    sendPatch();
  }
}

function setMenuAccordionsOpen(open){
  openCats.clear();
  if(open){
    openCats.add("allergen-key");
    MENU.forEach(section => openCats.add(section.category));
  }
  render();
}

function renderCart(){
  const p = getActivePerson();
  const cartEl = $("cart");
  cartEl.innerHTML = "";

  if(!p){
    cartEl.innerHTML = `<div class="hint">No people yet. Add someone.</div>`;
    return;
  }

  const entries = Object.entries(p.cart || {})
    .map(([key, qty]) => ({ key, qty, item: findMenuItemByKey(key) }))
    .filter(x => x.item && x.qty > 0)
    .sort((a,b) => a.item.name.localeCompare(b.item.name));

  if(entries.length === 0){
    cartEl.innerHTML = `<div class="hint">Empty cart for <b>${escapeHtml(p.name)}</b>.</div>`;
    return;
  }

  entries.forEach(({key, qty, item}) => {
    const row = document.createElement("div");
    row.className = "cartItem";

    const left = document.createElement("div");
    left.innerHTML = `
      <div class="line1">${escapeHtml(item.name)}</div>
      <div class="line2">${escapeHtml(key.split("|")[0])} · ${money(item.price)} each</div>
    `;

    const right = document.createElement("div");
    right.className = "meta";

    const lineTotal = document.createElement("div");
    lineTotal.className = "price";
    lineTotal.textContent = money(item.price * qty);

    const qtyEl = document.createElement("div");
    qtyEl.className = "qty";

    const minus = document.createElement("button");
    minus.type = "button";
    minus.textContent = "−";
    minus.onclick = () => { setCartQty(p, key, qty - 1); sendPatch(); };

    const count = document.createElement("span");
    count.textContent = String(qty);

    const plus = document.createElement("button");
    plus.type = "button";
    plus.textContent = "+";
    plus.onclick = () => { setCartQty(p, key, qty + 1); sendPatch(); };

    qtyEl.append(minus, count, plus);

    const del = document.createElement("button");
    del.className = "btn danger";
    del.style.padding = "8px 10px";
    del.textContent = "Remove";
    del.onclick = () => { setCartQty(p, key, 0); sendPatch(); };

    right.append(lineTotal, qtyEl, del);
    row.append(left, right);
    cartEl.appendChild(row);
  });
}

function renderTotals(){
  const p = getActivePerson();
  $("personTotal").textContent = money(p ? personTotal(p) : 0);
  $("grandTotal").textContent = money(grandTotal());
}

/* ===== All selections modal ===== */
function buildAllSelections(){
  const body = $("allBody");
  body.innerHTML = "";

  const people = (state.people || []).slice().sort((a,b) => a.name.localeCompare(b.name));
  const gt = grandTotal();

  let totalLines = 0;
  let totalItems = 0;

  people.forEach(p => {
    const entries = Object.entries(p.cart || {})
      .map(([key, qty]) => ({ key, qty, item: findMenuItemByKey(key) }))
      .filter(x => x.item && x.qty > 0)
      .sort((a,b) => a.item.name.localeCompare(b.item.name));

    const pTotal = personTotal(p);
    totalLines += entries.length;
    totalItems += entries.reduce((s,x)=>s + x.qty, 0);

    const block = document.createElement("div");
    block.className = "personBlock";

    const head = document.createElement("div");
    head.className = "personBlockHead";
    head.innerHTML = `
      <div class="headLeft">
        <span class="chev">▾</span>
        <div>
          <div class="personName">${escapeHtml(p.name)}</div>
          <div class="mini">${entries.length ? `${entries.length} line${entries.length!==1?"s":""}` : "No selections"}</div>
        </div>
      </div>
      <div class="price">${money(pTotal)}</div>
    `;

    const lines = document.createElement("div");
    lines.className = "personLines";

    if(entries.length === 0){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "Nothing selected.";
      lines.appendChild(empty);
    } else {
      entries.forEach(({key, qty, item}) => {
        const [cat] = key.split("|");
        const lineTotal = item.price * qty;

        const row = document.createElement("div");
        row.className = "lineRow";
        row.innerHTML = `
          <div>
            <div class="lineTitle">${escapeHtml(item.name)}</div>
            <div class="lineSub">${escapeHtml(cat)} · ${escapeHtml(item.id)} · ${money(item.price)} each</div>
          </div>
          <div class="mono rightMono colHideOnSmall">x${qty}</div>
          <div class="mono rightMono colHideOnSmall">${money(item.price)}</div>
          <div class="mono rightMono lineTotal">${money(lineTotal)}</div>
        `;
        lines.appendChild(row);
      });
    }

    head.addEventListener("click", () => {
      block.classList.toggle("collapsed");
      const chev = head.querySelector(".chev");
      if(chev) chev.textContent = block.classList.contains("collapsed") ? "▸" : "▾";
    });

    block.append(head, lines);
    body.appendChild(block);
  });

  $("allSummary").innerHTML =
    `${people.length} people · ${totalItems} item(s) · ${totalLines} line(s) · Grand total <span class="allSummaryGrand">${money(gt)}</span>`;
}

function showAll(){
  buildAllSelections();
  $("allOverlay").classList.add("show");
}

function setAllCollapsed(collapsed){
  const blocks = $("allBody").querySelectorAll(".personBlock");
  blocks.forEach(block => {
    block.classList.toggle("collapsed", collapsed);
    const chev = block.querySelector(".chev");
    if(chev) chev.textContent = collapsed ? "▸" : "▾";
  });
}

function closeAll(){
  $("allOverlay").classList.remove("show");
}

function buildTextSummary(){
  const people = (state.people || []).slice().sort((a,b) => a.name.localeCompare(b.name));
  const lines = [];

  people.forEach(p => {
    const entries = Object.entries(p.cart || {})
      .map(([key, qty]) => ({ key, qty, item: findMenuItemByKey(key) }))
      .filter(x => x.item && x.qty > 0)
      .sort((a,b) => a.item.name.localeCompare(b.item.name));

    lines.push(`${p.name} — ${money(personTotal(p))}`);
    if(entries.length === 0){
      lines.push(`  (no selections)`);
    } else {
      entries.forEach(({key, qty, item}) => {
        const cat = key.split("|")[0];
        lines.push(`  - ${item.name} [${cat}] x${qty} @ ${money(item.price)} = ${money(item.price * qty)}`);
      });
    }
    lines.push("");
  });

  lines.push(`GRAND TOTAL: ${money(grandTotal())}`);
  return lines.join("\n");
}

async function copySummary(){
  const text = buildTextSummary();
  try{
    await navigator.clipboard.writeText(text);
    const btn = $("copySummaryBtn");
    const old = btn.textContent;
    btn.textContent = "Copied";
    setTimeout(()=>btn.textContent = old, 900);
  }catch{
    alert("Clipboard failed. Your browser is being precious.");
  }
}

/* UI hooks */
$("search").addEventListener("input", render);
$("searchModeAnd").addEventListener("click", () => setSearchMode("and"));
$("searchModeOr").addEventListener("click", () => setSearchMode("or"));
$("menuExpandAllBtn").addEventListener("click", () => setMenuAccordionsOpen(true));
$("menuCloseAllBtn").addEventListener("click", () => setMenuAccordionsOpen(false));
const roomHistorySelect = $("roomHistory");
if(roomHistorySelect){
  roomHistorySelect.addEventListener("change", (e) => {
    const val = e.target.value;
    if(!val) return;
    setRoomValue(val);
    connect();
  });
}
const roomInput = $("room");
if(roomInput) roomInput.addEventListener("change", connect);
const deleteRoomBtn = $("deleteRoomBtn");
if(deleteRoomBtn){
  deleteRoomBtn.addEventListener("click", () => {
    const room = getRoomValue();
    if(!confirm(`Delete session "${room}" for everyone? This cannot be undone.`)) return;
    if(!ws || ws.readyState !== WebSocket.OPEN){
      alert("Not connected to the server.");
      return;
    }
    ws.send(JSON.stringify({ type: "delete_room" }));
  });
}

$("addPersonBtn").addEventListener("click", () => {
  const name = prompt("Person name?");
  if(!name) return;
  if(!Array.isArray(state.people)) state.people = [];
  const trimmed = name.trim().slice(0,30);
  if(!trimmed) return;
  const exists = state.people.some(p => p.name.trim().toLowerCase() === trimmed.toLowerCase());
  if(exists){
    alert("That name already exists in this session.");
    return;
  }
  const p = { id: uid(), name: trimmed, cart: {} };
  state.people.push(p);
  state.activePersonId = p.id;
  if(ws && ws.readyState === WebSocket.OPEN) sendPatch();
  else render();
});

$("removePersonBtn").addEventListener("click", () => {
  const p = getActivePerson();
  if(!p) return;
  if(!confirm(`Remove ${p.name} and their cart for everyone?`)) return;
  state.people = state.people.filter(x => x.id !== p.id);
  state.activePersonId = state.people[0]?.id || null;
  sendPatch();
});

$("clearCartBtn").addEventListener("click", () => {
  const p = getActivePerson();
  if(!p) return;
  if(!confirm(`Clear cart for ${p.name} for everyone?`)) return;
  p.cart = {};
  sendPatch();
});

/* Modal hooks */
$("showAllBtn").addEventListener("click", showAll);
$("expandAllBtn").addEventListener("click", () => setAllCollapsed(false));
$("collapseAllBtn").addEventListener("click", () => setAllCollapsed(true));
$("closeAllBtn").addEventListener("click", closeAll);
$("copySummaryBtn").addEventListener("click", copySummary);
$("allOverlay").addEventListener("click", (e) => {
  if(e.target === $("allOverlay")) closeAll();
});
window.addEventListener("keydown", (e) => {
  if(e.key === "Escape") closeAll();
});

setConn(false, "Disconnected");
loadLocalAllergens();
loadDietFilters();
loadRoomHistory();
updateRoomHistoryUI();
connect();
</script>
</body>
</html>
